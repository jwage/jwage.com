<!DOCTYPE html>
<html>
    <head>
        <title>Blending the Doctrine ORM and MongoDB ODM &mdash; jwage.com &mdash; I am Jonathan H. Wage</title>
        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <meta name="robots" content="index, follow">
        <link href="https://jwage.com/components/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="https://jwage.com/css/style.css" rel="stylesheet" type="text/css" />
        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="stylesheet" href="https://jwage.com/components/highlightjs/styles/github.css" />
        <link rel="alternate" type="application/atom+xml" href="https://jwage.com/atom.xml" title="jwage.com activity feed" />
        <style>
        /** quick fix because bootstrap <pre> has a background-color. */
        pre code { background-color: inherit; }
        </style>
                                    </head>
    <body>
        <header>
            <nav class="navbar navbar-inverse navbar-fixed-top">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="https://jwage.com/">jwage.com</a>
                    </div>
                    <div id="navbar" class="collapse navbar-collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="https://jwage.com/about">About</a></li>
                            <li><a href="https://jwage.com/blog">Blog</a></li>
                        </ul>
                    </div>
                </div>
            </nav>
        </header>
        <div class="mainContent container">
            <div class="row-fluid">
                <div class="span8">
                        <article>
        <header>
            <h2>Blending the Doctrine ORM and MongoDB ODM <small>post</small></h2>
        </header>
        <div>
            <p>Since the start of the <a href="http://www.doctrine-project.org/projects/mongodb_odm" target="_blank">Doctrine MongoDB Object Document Mapper</a> project people have asked how it can be integrated with the <a href="http://www.doctrine-project.org/projects/orm" target="_blank">ORM</a>. This blog post demonstrates how you can integrate the two transparently, maintaining a clean domain model.</p>

<p>This example will have a <code>Product</code> that is stored in MongoDB and the <code>Order</code> stored in a MySQL database.</p>

<h2>Defining our Document and Entity</h2>

<p>First lets define our <code>Product</code> document:</p>

<pre><code>namespace Documents;

/** @Document */
class Product
{
    /** @Id */
    private $id;

    /** @String */
    private $title;

    public function getId()
    {
        return $this-&gt;id;
    }

    public function getTitle()
    {
        return $this-&gt;title;
    }

    public function setTitle($title)
    {
        $this-&gt;title = $title;
    }
}
</code></pre>

<p>Next create the <code>Order</code> entity that has a <code>$product</code> and <code>$productId</code> property linking it to the <code>Product</code> that is stored with MongoDB:</p>

<pre><code>namespace Entities;

use Documents\Product;

/**
 * @Entity
 * @Table(name="orders")
 * @HasLifecycleCallbacks
 */
class Order
{
    /**
     * @Id @Column(type="integer")
     * @GeneratedValue(strategy="AUTO")
     */
    private $id;

    /**
     * @Column(type="string")
     */
    private $productId;

    /**
     * @var Documents\Product
     */
    private $product;

    public function getId()
    {
        return $this-&gt;id;
    }

    public function getProductId()
    {
        return $this-&gt;productId;
    }

    public function setProduct(Product $product)
    {
        $this-&gt;productId = $product-&gt;getId();
        $this-&gt;product = $product;
    }

    public function getProduct()
    {
        return $this-&gt;product;
    }
}
</code></pre>

<h2>Event Subscriber</h2>

<p>Now we need to setup an event subscriber that will set the <code>$product</code> property of all <code>Order</code> instances to a reference to the document product so it can be lazily loaded when it is accessed the first time. So first register a new event subscriber:</p>

<pre><code>$eventManager = $em-&gt;getEventManager();
$eventManager-&gt;addEventListener(
    array(\Doctrine\ORM\Events::postLoad), new MyEventSubscriber($dm)
);
</code></pre>

<p>So now we need to define a class named <code>MyEventSubscriber</code> and pass a dependency to the <code>DocumentManager</code>. It will have a <code>postLoad()</code> method that sets the product document reference:</p>

<pre><code>use Doctrine\ODM\MongoDB\DocumentManager;
use Doctrine\ORM\Event\LifecycleEventArgs;

class MyEventSubscriber
{
    public function __construct(DocumentManager $dm)
    {
        $this-&gt;dm = $dm;
    }

    public function postLoad(LifecycleEventArgs $eventArgs)
    {
        $order = $eventArgs-&gt;getEntity();
        $em = $eventArgs-&gt;getEntityManager();
        $productReflProp = $em-&gt;getClassMetadata('Entities\Order')
            -&gt;reflClass-&gt;getProperty('product');
        $productReflProp-&gt;setAccessible(true);
        $productReflProp-&gt;setValue(
            $order, $this-&gt;dm-&gt;getReference('Documents\Product', $order-&gt;getProductId())
        );
    }
}
</code></pre>

<p>The <code>postLoad</code> method will be invoked after an ORM entity is loaded from the database. This allows us to use the <code>DocumentManager</code> to set the <code>$product</code> property with a reference to the <code>Product</code> document with the product id we previously stored.</p>

<p>First create a new <code>Product</code>:</p>

<pre><code>$product = new \Documents\Product();
$product-&gt;setTitle('Test Product');
$dm-&gt;persist($product);
$dm-&gt;flush();
</code></pre>

<p>Now create a new <code>Order</code> and link it to a <code>Product</code> in MySQL:</p>

<pre><code>$order = new \Entities\Order();
$order-&gt;setProduct($product);
$em-&gt;persist($order);
$em-&gt;flush();
</code></pre>

<p>Later we can retrieve the entity and lazily load the reference to the document in MongoDB:</p>

<pre><code>$order = $em-&gt;find('Order', $order-&gt;getId());

// Instance of an uninitialized product proxy
$product = $order-&gt;getProduct();

// Initializes proxy and queries the database
echo "Order Title: " . $product-&gt;getTitle();
</code></pre>

<p>If you were to print the <code>$order</code> you would see that we got back regular PHP objects:</p>

<pre><code>print_r($order);
</code></pre>

<p>The above would output the following:</p>

<pre><code>Order Object
(
    [id:Entities\Order:private] =&gt; 53
    [productId:Entities\Order:private] =&gt; 4c74a1868ead0ed7a9000000
    [product:Entities\Order:private] =&gt; Proxies\DocumentsProductProxy Object
        (
            [__isInitialized__] =&gt; 1
            [id:Documents\Product:private] =&gt; 4c74a1868ead0ed7a9000000
            [title:Documents\Product:private] =&gt; Test Product
        )

)
</code></pre>

<p>That is it! It is not a very abstract example right now but it demonstrates how to utilize the events to do some very interesting things with the Doctrine persistence libraries! I hope that now someone will inspired to create an extension that offers an abstract solution for blending the ORM and ODM together!</p>

        </div>
                
                    <nav class="article">
                <ul>
                                            <li>Next: <a class="next" href="https://jwage.com/post/2011/02/28/tips-on-being-successful-in-open-source" title="Tips on Being Successful in Open Source"><span class="title">Tips on Being Successful in Open Source</span></a></li>
                                                                <li>Previous: <a class="previous" href="https://jwage.com/post/2010/08/19/new-doctrine-mongodb-odm-documentation" title="New Doctrine MongoDB ODM Documentation"><span class="title">New Doctrine MongoDB ODM Documentation</span></a></li>
                                    </ul>
            </nav>
            </article>



                </div>
            </div>
        </div>
        <footer class="container">
            &copy; 2018 jwage.com
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="https://jwage.com/components/jquery/jquery.min.js"><\/script>')</script>
        <script src="https://jwage.com/components/bootstrap/js/bootstrap.min.js"></script>
                
                <script src="https://jwage.com/components/highlightjs/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

                    </body>
</html>
