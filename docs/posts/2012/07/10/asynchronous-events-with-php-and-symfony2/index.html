<!DOCTYPE html>
<html>
    <head>
        <title>Asynchronous Events with PHP and Symfony2 &mdash; jwage.com &mdash; I am Jonathan H. Wage</title>

        <meta charset="utf-8">
        <meta name="theme-color" content="#ffffff">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

            <meta name="robots" content="index, follow">

        <link href="https://jwage.com/components/bootstrap/css/bootstrap.min.css?3" rel="stylesheet" type="text/css" />
        <link href="https://jwage.com/css/style.css?3" rel="stylesheet" type="text/css" />

        <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
        <!--[if lt IE 9]>
            <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->

        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">

        <link rel="stylesheet" href="https://jwage.com/components/highlightjs/styles/github.css?3" />
        <link rel="alternate" type="application/atom+xml" href="https://jwage.com/atom.xml" title="jwage.com activity feed" />

        
            </head>
    <body>

        <header>
            <!-- Fixed navbar -->
            <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
                <a class="navbar-brand" href="https://jwage.com"><img src="https://jwage.com/images/me.jpg" class="rounded-circle mr-3" />jwage.com</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <ul class="navbar-nav mr-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="https://jwage.com">Home</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://jwage.com/blog">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://jwage.com/articles">Articles</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://jwage.com/kubota-l210">Kubota L210</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="https://jwage.com/archive">Archive</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>

        <!-- Begin page content -->
        <main role="main" class="container">
                <article>
        <header>
            <h2>Asynchronous Events with PHP and Symfony2 <small>post</small></h2>
        </header>
        <div>
            <p><a href="http://symfony.com" target="_blank">Symfony2</a> is a great framework. I use it at <a href="https://opensky.com" target="_blank">OpenSky</a> daily and have contributed a little bit of code to it related to the <a href="http://doctrine-project.org" target="_blank">Doctrine</a> integration.</p>

<h2>Symfony2 EventDispatcher</h2>

<p>One of the core components is the <a href="https://github.com/symfony/EventDispatcher" target="_blank">EventDispatcher</a> and it implements a lightweight version of the <a href="http://en.wikipedia.org/wiki/Observer_pattern" target="_blank">Observer design pattern</a>.</p>

<p>At <a href="http://opensky.com" target="_blank">OpenSky</a> we make heavy use of events. All of our core functionality notifies events that we can then listen to and execute other functionality. Here is an example where we notify the <strong>user.created</strong> event when a new user registers on the site:</p>

<pre><code>$eventDispatcher-&gt;notify(new Event($user, 'user.created'));
</code></pre>

<p>Now we can setup a listener for that and execute some more PHP code in the same process:</p>

<pre><code>&lt;service id="user.created.listener" class="UserCreatedListener"&gt;
    &lt;tag name="kernel.event_listener" event="user.created" method="onUserCreated" /&gt;
&lt;/service&gt;
</code></pre>

<p>The listener class might look something like this:</p>

<pre><code>class UserCreatedListener
{
    public function onUserCreated(EventInterface $event)
    {
        $user = $event-&gt;getSubject(); // $user instanceof User
        $params = $event-&gt;all();
        // do something
    }
}
</code></pre>

<p>The above gets executed in the same process that the <strong>user.created</strong> event was notified in.</p>

<h2>Notifying Asynchronous Events</h2>

<p>What if we want to do something else, like notify a third party API of the new user. We shouldn&rsquo;t do that in the main request as it would slow it down, and it doesn&rsquo;t need to be real time, so an asynchronous event is perfect.</p>

<p>At OpenSky we make use of <a href="https://www.jboss.org/hornetq" target="_blank">HornetQ</a>, a message queue, and a Java application written using <a href="http://en.wikipedia.org/wiki/Mule_(software)" target="_blank">Mule</a> to consume messages our PHP application sends. We&rsquo;ve added a way for Symfony2 events to be forwarded to HornetQ which are then received by our Java app and POSTed back to our PHP application in another request.</p>

<p>Sending an asynchronous event from our PHP app looks like this:</p>

<pre><code>$eventDispatcher-&gt;notifyAsync(new Event($user, 'user.created'));
</code></pre>

<p>The above would not execute any <strong>user.created</strong> listeners in this process, instead the <strong>Event</strong> instance is sent through HornetQ, received by our Java app and POSTed back to our PHP application in another request. The Java app posts to a controller that reconstructs the <strong>Event</strong> object and notifies it on the event dispatcher.</p>

<p>So this ends up happening but in another request/process:</p>

<pre><code>class EventController
{
    public function handle()
    {
        $event = $this-&gt;getEventFactory()-&gt;getReconstructedEvent($request);
        $this-&gt;getEventDispatcher()-&gt;notify($event);
    }
}
</code></pre>

<p>Now any code that listens on <strong>user.created</strong> will be executed in an asynchronous process:</p>

<pre><code>class UserCreatedListener
{
    // ...

    public function onUserCreated(EventInterface $event)
    {
        $user = $event-&gt;getSubject(); // $user instanceof User
        $this-&gt;someApi-&gt;notifyNewUser($user);
    }
}
</code></pre>

<h2>I don&rsquo;t have a message queue</h2>

<p>In order for you to implement the above example you will need some kind of message queue and middle ware. If you don&rsquo;t have that you could very easily stash the calls to notifyAsync() and issue the events as async ajax requests when the response renders in the browser or implement some other kind of event persistence and a console command that runs as a daemon constantly processing the events. It is possible to build out a smaller scale version of the example above that is easy to upgrade later.</p>

        </div>
                    <p class="categories">
            Categories:
                        <a href="https://jwage.com/blog/categories/articles">articles</a>                        </p>
                
                    <nav class="article">
                <ul>
                                            <li>Next: <a class="next" href="https://jwage.com/posts/2012/07/10/testing-query-counts-in-functional-web-tests-with" title="Testing query counts in functional web tests with Symfony2 and PHPUnit"><span class="title">Testing query counts in functional web tests with Symfony2 and PHPUnit</span></a></li>
                                                                <li>Previous: <a class="previous" href="https://jwage.com/posts/2012/02/22/logging-mongodb-explains-in-symfony2" title="Logging MongoDB Explains in Symfony2"><span class="title">Logging MongoDB Explains in Symfony2</span></a></li>
                                    </ul>
            </nav>
            </article>



        </main>

        <footer class="footer">
            <div class="container">
                <span class="text-muted">&copy; 2018 jwage.com</span>
            </div>
        </footer>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js?3"></script>
        <script>window.jQuery || document.write('<script src="https://jwage.com/components/jquery/jquery.min.js?3"><\/script>')</script>
        <script src="https://jwage.com/components/bootstrap/js/bootstrap.min.js?3"></script>

        
                    <script type="text/javascript">
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

                ga('create', 'UA-288343-6', 'auto');
                ga('send', 'pageview');
            </script>
        
        <script src="https://jwage.com/components/highlightjs/highlight.pack.js?3"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        
            </body>
</html>
